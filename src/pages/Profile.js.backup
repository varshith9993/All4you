import React, { useState, useEffect, useRef } from "react";
import { useNavigate } from "react-router-dom";
import {
  FiEdit2,
  FiCamera,
  FiMoreVertical,
  FiBriefcase,
  FiTool,
  FiTag,
  FiList,
  FiStar,
  FiMapPin,
  FiWifi,
} from "react-icons/fi";
import { onAuthStateChanged } from "firebase/auth";
import {
  doc,
  getDoc,
  updateDoc,
  collection,
  query,
  where,
  getDocs,
  deleteDoc,
  onSnapshot,
} from "firebase/firestore";
import { db, auth } from "../firebase";
import { useLocationWithAddress } from "../hooks/useLocationWithAddress";
import defaultAvatar from "../assets/images/default_profile.png";
import Layout from "../components/Layout";

const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/devs4x2aa/upload";
const CLOUDINARY_UPLOAD_PRESET = "ml_default";

async function uploadToCloudinary(file) {
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
  const res = await fetch(CLOUDINARY_UPLOAD_URL, { method: "POST", body: formData });
  const data = await res.json();
  return data.secure_url || "";
}

// Helper functions
function getDistanceKm(lat1, lon1, lat2, lon2) {
  const lat1Num = parseFloat(lat1);
  const lon1Num = parseFloat(lon1);
  const lat2Num = parseFloat(lat2);
  const lon2Num = parseFloat(lon2);
  if (isNaN(lat1Num) || isNaN(lon1Num) || isNaN(lat2Num) || isNaN(lon2Num)) return null;
  const R = 6371;
  const dLat = (lat2Num - lat1Num) * Math.PI / 180;
  const dLon = (lon2Num - lon1Num) * Math.PI / 180;
  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1Num * Math.PI / 180) * Math.cos(lat2Num * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

function formatLastSeen(lastSeen) {
  if (!lastSeen) return "Never online";
  try {
    let date = lastSeen.toDate ? lastSeen.toDate() : lastSeen.seconds ? new Date(lastSeen.seconds * 1000) : new Date(lastSeen);
    const now = new Date();
    const diffMs = now - date;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    if (diffSecs < 60) return "Last Seen: just now";
    if (diffMins < 60) return `Last Seen: ${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
    if (diffHours < 24) return `Last Seen: ${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
    if (diffDays === 1) return "Last Seen: yesterday";
    if (diffDays < 7) return `Last Seen: ${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `Last Seen: ${day}/${month}/${year}`;
  } catch (error) {
    return "Offline";
  }
}

function isUserOnline(userId, currentUserId, online, lastSeen) {
  if (userId === currentUserId) return true;
  if (online === true) {
    if (!lastSeen) return true;
    try {
      let date = lastSeen.toDate ? lastSeen.toDate() : lastSeen.seconds ? new Date(lastSeen.seconds * 1000) : new Date(lastSeen);
      return (new Date().getTime() - date.getTime()) < 5000;
    } catch (error) {
      return true;
    }
  }
  if (online === false) return false;
  if (!lastSeen) return false;
  try {
    let date = lastSeen.toDate ? lastSeen.toDate() : lastSeen.seconds ? new Date(lastSeen.seconds * 1000) : new Date(lastSeen);
    return (new Date().getTime() - date.getTime()) < 5000;
  } catch (error) {
    return false;
  }
}

export default function Profile() {
  const navigate = useNavigate();
  const [user, setUser] = useState(null);
  const [profile, setProfile] = useState(null);
  const [editMode, setEditMode] = useState(false);
  const [editingProfile, setEditingProfile] = useState({});
  const [imagePreview, setImagePreview] = useState("");
  const [statusMsg, setStatusMsg] = useState("");
  const [profileSaving, setProfileSaving] = useState(false);
  const [tab, setTab] = useState("workers");
  const [servicePhase, setServicePhase] = useState("all");
  const [posts, setPosts] = useState({ workers: [], services: [], ads: [] });
  const [loading, setLoading] = useState(true);
  const [menuPostId, setMenuPostId] = useState(null);
  const [showConfirm, setShowConfirm] = useState(false);
  const [confirmProps, setConfirmProps] = useState({});
  const [showAbout, setShowAbout] = useState(false);
  const [manualLocationTouched, setManualLocationTouched] = useState(false);
  const [userProfiles, setUserProfiles] = useState({});

  const { location, address, error: locationErr, loading: locationLoading, addressLoading, requestLocation } = useLocationWithAddress();

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!user) return;
    setLoading(true);
    async function load() {
      try {
        const profileRef = doc(db, "profiles", user.uid);
        const profileSnap = await getDoc(profileRef);

        const [workers, services, ads] = await Promise.all([
          getDocs(query(collection(db, "workers"), where("createdBy", "==", user.uid))),
          getDocs(query(collection(db, "services"), where("createdBy", "==", user.uid))),
          getDocs(query(collection(db, "ads"), where("createdBy", "==", user.uid))),
        ]);

        const profileData = profileSnap.exists() ? profileSnap.data() : {};
        setProfile(profileData);
        setEditingProfile(profileData);

        // Set user's own profile in userProfiles
        setUserProfiles({ [user.uid]: profileData });

        setPosts({
          workers: workers.docs.map((d) => ({ id: d.id, ...d.data() })),
          services: services.docs.map((d) => ({ id: d.id, ...d.data() })),
          ads: ads.docs.map((d) => ({ id: d.id, ...d.data() })),
        });
      } catch (e) {
        console.error("Error loading profile:", e);
      }
      setLoading(false);
    }
    load();
  }, [user]);

  // Real-time profile updates
  useEffect(() => {
    if (!user) return;
    const unsubscribe = onSnapshot(doc(db, 'profiles', user.uid), (profileSnap) => {
      if (profileSnap.exists()) {
        const profileData = profileSnap.data();
        setProfile(profileData);
        setUserProfiles(prev => ({ ...prev, [user.uid]: profileData }));
      }
    });
    return () => unsubscribe();
  }, [user]);

  useEffect(() => {
    if (!editMode || manualLocationTouched) return;
    if (location && address) {
      setEditingProfile((prev) => ({
        ...prev,
        latitude: location.latitude,
        longitude: location.longitude,
        place: address.place || "",
        city: address.city || "",
        pincode: address.pincode || "",
      }));
      setStatusMsg("Location autofilled!");
    }
    if (locationErr) setStatusMsg(locationErr);
  }, [location, address, locationErr, editMode, manualLocationTouched]);

  function startEditing() {
    setEditingProfile(profile);
    setImagePreview("");
    setEditMode(true);
    setStatusMsg("");
    setManualLocationTouched(false);
  }
  function cancelEditing() {
    setEditingProfile(profile);
    setImagePreview("");
    setEditMode(false);
    setStatusMsg("");
    setManualLocationTouched(false);
  }
  async function handleImageChange(e) {
    const file = e.target.files[0];
    if (file) {
      setStatusMsg("Uploading image...");
      const url = await uploadToCloudinary(file);
      setEditingProfile((prev) => ({ ...prev, profileImage: url }));
      setImagePreview(url);
      setStatusMsg("Upload successful!");
    }
  }
  function handleInputChange(e) {
    const { name, value } = e.target;
    setEditingProfile((prev) => ({ ...prev, [name]: value }));
    if (
      ["city", "place", "pincode", "landmark", "latitude", "longitude"].includes(name)
    ) {
      setManualLocationTouched(true);
    }
  }
  async function handleGetLocation() {
    setStatusMsg("Getting location...");
    setManualLocationTouched(false);
    requestLocation();
  }
  async function handleSave() {
    setProfileSaving(true);
    await updateDoc(doc(db, "profiles", user.uid), {
      city: editingProfile.city || "",
      place: editingProfile.place || "",
      pincode: editingProfile.pincode || "",
      latitude: editingProfile.latitude || "",
      longitude: editingProfile.longitude || "",
      landmark: editingProfile.landmark || "",
      profileImage: editingProfile.profileImage || "",
    });
    setProfile((prev) => ({ ...prev, ...editingProfile }));
    setEditMode(false);
    setProfileSaving(false);
    setStatusMsg("");
    setManualLocationTouched(false);
  }

  // Empty state components for each tab
  const EmptyState = ({ type }) => {
    const getEmptyConfig = () => {
      switch (type) {
        case "workers":
          return {
            icon: FiBriefcase,
            title: "No Workers Available",
            description: "You haven't posted any workers yet.",
            actionText: "Post a Worker",
            action: () => navigate("/add-workers")
          };
        case "services":
          return {
            icon: FiTool,
            title: "No Services Found",
            description: servicePhase === "all"
              ? "You haven't posted any services yet."
              : `You haven't posted any ${servicePhase} services yet.`,
            actionText: "Post a Service",
            action: () => navigate("/add-services")
          };
        case "ads":
          return {
            icon: FiTag,
            title: "No Ads Posted",
            description: "You haven't created any advertisements yet.",
            actionText: "Create an Ad",
            action: () => navigate("/add-ads")
          };
        default:
          return {
            icon: FiList,
            title: "No Items Found",
            description: "You haven't posted anything here yet.",
            actionText: "Get Started",
            action: () => navigate("/" + type)
          };
      }
    };

    const config = getEmptyConfig();
    const IconComponent = config.icon;

    return (
      <div className="text-center py-12 px-4">
        <IconComponent size={48} className="mx-auto text-gray-300 mb-4" />
        <h3 className="text-lg font-semibold text-gray-600 mb-2">{config.title}</h3>
        <p className="text-sm text-gray-500 mb-6 max-w-xs mx-auto">{config.description}</p>
        <button
          onClick={config.action}
          className="px-6 py-2 bg-gradient-to-r from-indigo-600 to-pink-600 text-white rounded-xl hover:opacity-90 transition-all text-sm font-bold shadow-lg shadow-indigo-500/30"
        >
          {config.actionText}
        </button>
      </div>
    );
  };

  // Worker Card - Matching Workers.js design
  function WorkerCard({ post }) {
    const { title, rating = 0, location = {}, tags = [], latitude, longitude, createdBy, avatarUrl } = post;
    const workerCreatorProfile = userProfiles[createdBy] || {};
    const displayUsername = workerCreatorProfile.username || "Unknown User";
    const displayProfileImage = avatarUrl || workerCreatorProfile.photoURL || workerCreatorProfile.profileImage || defaultAvatar;
    const displayOnline = workerCreatorProfile.online;
    const displayLastSeen = workerCreatorProfile.lastSeen;

    let distanceText = "Distance away: --";
    if (profile && profile.latitude && profile.longitude && latitude && longitude) {
      const distance = getDistanceKm(profile.latitude, profile.longitude, latitude, longitude);
      if (distance !== null && !isNaN(distance)) {
        const distValue = distance < 1 ? `${Math.round(distance * 1000)}m` : `${distance.toFixed(1)}km`;
        distanceText = `Distance away: ${distValue} away`;
      }
    }
    <img
      src={photos[0]}
      alt={title}
      className="w-full h-48 object-cover rounded-lg"
      onError={(e) => {
        e.target.style.display = 'none';
      }}
    />
            </div >
          )
  }

  <h4 className="font-medium text-gray-900 mb-2 line-clamp-2">{title}</h4>

  {/* Tags */ }
  {
    tags && tags.length > 0 && (
      <div className="flex flex-wrap gap-1 mb-2">
        {tags.slice(0, 3).map((tag, index) => (
          <span
            key={index}
            className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs"
          >
            {tag}
          </span>
        ))}
        {tags.length > 3 && (
          <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">
            +{tags.length - 3} more
          </span>
        )}
      </div>
    )
  }

  {/* Location */ }
  {
    location && (location.city || location.area) && (
      <div className="text-xs text-gray-600 mt-2">
        üìç {[location.area, location.city].filter(Boolean).join(", ")}
      </div>
    )
  }

  {/* Status Badge */ }
  {
    post.status && post.status !== "active" && (
      <span className="text-[10px] px-2 py-0.5 bg-red-50 text-red-600 rounded-full mt-2 inline-block font-medium border border-red-100">{post.status}</span>
    )
  }
        </div >

    { menuPostId === post.id && (
      <PostMenu
        post={post}
        closeMenu={() => setMenuPostId(null)}
        updatePosts={setPosts}
        currentTab={tab}
        setShowConfirm={setShowConfirm}
        setConfirmProps={setConfirmProps}
        setShowAbout={setShowAbout}
        navigate={navigate}
      />
    )
}
      </div >
    );
  }

function renderPostCard(post) {
  if (tab === "workers") {
    return <WorkerCard key={post.id} post={post} />;
  } else if (tab === "services") {
    return <ServiceCard key={post.id} post={post} />;
  } else if (tab === "ads") {
    return <AdCard key={post.id} post={post} />;
  }
  return null;
}

// Get filtered posts for current tab
const getFilteredPosts = () => {
  if (tab === "services") {
    return posts.services.filter((p) =>
      servicePhase === "all" ? true : p.type === servicePhase
    );
  }
  return posts[tab];
};

const filteredPosts = getFilteredPosts();

if (loading) return (
  <div className="flex justify-center items-center h-screen">
    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
  </div>
);

return (
  <Layout
    title="ServePure"
    activeTab="profile"
  >
    <div className="pb-20">
      {/* Profile Info Section */}
      <section className="relative mt-4 mx-4 p-6 bg-white rounded-3xl shadow-sm border border-gray-100 flex flex-col items-center overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-24 bg-gradient-to-r from-indigo-500 to-pink-500 opacity-10"></div>

        <div className="relative mb-3 mt-2">
          <img
            src={editMode ? imagePreview || editingProfile.profileImage || defaultAvatar : profile?.profileImage || defaultAvatar}
            alt="Profile"
            className="w-28 h-28 rounded-full border-4 border-white shadow-lg object-cover"
          />
          {editMode && (
            <label className="absolute bottom-1 right-1 bg-indigo-600 text-white p-2 rounded-full cursor-pointer shadow-md hover:bg-indigo-700 transition-colors">
              <FiCamera size={16} />
              <input type="file" accept="image/*" className="hidden" onChange={handleImageChange} />
            </label>
          )}
        </div>

        <h2 className="font-bold text-xl text-gray-900">{profile?.username}</h2>
        <p className="text-sm text-gray-500 mb-1">{user?.email}</p>

        <div className="flex items-center gap-1 text-xs text-gray-600 bg-gray-50 px-3 py-1 rounded-full border border-gray-100 mt-2">
          <span className="truncate max-w-[200px]">
            {profile?.place && profile?.city ? `${profile.place}, ${profile.city}` : "Location not set"}
            {profile?.pincode ? `, ${profile.pincode}` : ""}
          </span>
        </div>

        {!editMode && (
          <button
            className="mt-6 px-6 py-2.5 bg-white border border-gray-200 text-gray-700 rounded-xl flex items-center gap-2 text-sm font-bold hover:bg-gray-50 transition-all shadow-sm"
            onClick={startEditing}
          >
            <FiEdit2 size={14} /> Edit Profile
          </button>
        )}

        {editMode && (
          <div className="w-full flex flex-col items-center mt-6 space-y-3 animate-fade-in">
            <input type="text" name="city" value={editingProfile.city || ""} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="City" />
            <input type="text" name="place" value={editingProfile.place || ""} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Place" />
            <input type="text" name="pincode" value={editingProfile.pincode || ""} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Pincode" />
            <input type="text" name="landmark" value={editingProfile.landmark || ""} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Landmark (optional)" />

            <div className="grid grid-cols-2 gap-3 w-full">
              <input type="text" name="latitude" value={editingProfile.latitude || ""} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Latitude" />
              <input type="text" name="longitude" value={editingProfile.longitude || ""} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50" placeholder="Longitude" />
            </div>

            <button className="w-full py-2 text-indigo-600 text-xs font-bold hover:underline" onClick={handleGetLocation} disabled={locationLoading || addressLoading}>
              {locationLoading || addressLoading ? "Getting location..." : "Get Current Location"}
            </button>

            <div className="text-xs text-indigo-600 font-medium h-4">{statusMsg}</div>

            <div className="flex gap-3 w-full pt-2">
              <button className="flex-1 py-2.5 bg-gray-100 text-gray-700 rounded-xl font-bold text-sm hover:bg-gray-200" onClick={cancelEditing}>
                Cancel
              </button>
              <button className="flex-1 py-2.5 bg-gradient-to-r from-indigo-600 to-pink-600 text-white rounded-xl font-bold text-sm hover:opacity-90 shadow-lg shadow-indigo-500/30" onClick={handleSave} disabled={profileSaving}>
                {profileSaving ? "Saving..." : "Save Changes"}
              </button>
            </div>
          </div>
        )}
      </section>

      {/* Tabs for posts */}
      <section className="mx-4 mt-6 bg-white rounded-3xl shadow-sm border border-gray-100">
        <div className="flex border-b border-gray-100 rounded-t-3xl overflow-hidden">
          {["workers", "services", "ads"].map((k) => (
            <button
              key={k}
              className={`flex-1 py-3 text-sm font-bold transition-all ${tab === k ? "text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50" : "text-gray-400 hover:text-gray-600"}`}
              onClick={() => setTab(k)}
            >
              {k.charAt(0).toUpperCase() + k.slice(1)} <span className="text-xs opacity-70">({posts[k].length})</span>
            </button>
          ))}
        </div>

        {tab === "services" && (
          <div className="flex p-2 gap-2 justify-center bg-gray-50/50 border-b border-gray-100">
            {["all", "providing", "asking"].map((k) => (
              <button key={k} onClick={() => setServicePhase(k)}
                className={`px-3 py-1 rounded-lg text-xs font-bold capitalize transition-all ${servicePhase === k ? "bg-white text-indigo-600 shadow-sm border border-gray-100" : "text-gray-400 hover:text-gray-600"}`}>
                {k}
              </button>
            ))}
          </div>
        )}

        {/* Posts list or empty state */}
        <div className="p-4 min-h-[200px]">
          {filteredPosts.length === 0 ? (
            <EmptyState type={tab} />
          ) : (
            <div>
              {filteredPosts.map(renderPostCard)}
            </div>
          )}
        </div>
      </section>
    </div>

    {/* Modals */}
    {showConfirm && (
      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in">
        <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full text-center m-4">
          <p className="mb-6 font-medium text-gray-800">{confirmProps.text}</p>
          <div className="flex justify-center gap-3">
            <button className="flex-1 bg-gray-100 text-gray-700 px-4 py-2.5 rounded-xl font-bold hover:bg-gray-200 transition-colors" onClick={() => setShowConfirm(false)}>
              No
            </button>
            <button className="flex-1 bg-gradient-to-r from-indigo-600 to-pink-600 text-white px-4 py-2.5 rounded-xl font-bold hover:opacity-90 shadow-lg shadow-indigo-500/30 transition-all" onClick={confirmProps.onConfirm}>
              Yes
            </button>
          </div>
        </div>
      </div>
    )}
    {showAbout && (
      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fade-in">
        <div className="bg-white p-6 rounded-2xl shadow-2xl max-w-xs w-full text-left m-4">
          <h2 className="font-bold mb-4 text-lg text-gray-900">What do these options do?</h2>
          <ul className="text-left text-sm mb-6 space-y-3 text-gray-600">
            <li className="flex gap-2"><span className="font-bold text-gray-900 min-w-[60px]">Edit:</span> Modify post details (active only).</li>
            <li className="flex gap-2"><span className="font-bold text-gray-900 min-w-[60px]">Enable:</span> Activate a disabled post.</li>
            <li className="flex gap-2"><span className="font-bold text-gray-900 min-w-[60px]">Disable:</span> Hide active post from public.</li>
            <li className="flex gap-2"><span className="font-bold text-gray-900 min-w-[60px]">Expire:</span> Mark post finished but keep in profile.</li>
            <li className="flex gap-2"><span className="font-bold text-gray-900 min-w-[60px]">Delete:</span> Remove post permanently.</li>
          </ul>
          <button className="bg-gray-100 text-gray-800 rounded-xl px-4 py-2.5 block w-full font-bold hover:bg-gray-200 transition-colors" onClick={() => setShowAbout(false)}>
            Close
          </button>
        </div>
      </div>
    )}
  </Layout>
);
}

function PostMenu({ post, closeMenu, updatePosts, currentTab, setShowConfirm, setConfirmProps, setShowAbout, navigate }) {
  const menuRef = useRef(null);

  useEffect(() => {
    function handleClickOutside(e) {
      if (menuRef.current && !menuRef.current.contains(e.target)) closeMenu();
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [closeMenu]);

  async function handleAction(action) {
    const col = currentTab;
    const ref = doc(db, col, post.id);
    if (action === "edit") {
      closeMenu();
      if (col === "workers") navigate(`/editworker/${post.id}`);
      else if (col === "services") navigate(`/editservice/${post.id}`);
      else navigate(`/editad/${post.id}`);
      return;
    }
    if (["enable", "disable", "expire", "delete"].includes(action)) {
      setShowConfirm(true);
      setConfirmProps({
        text:
          action === "enable"
            ? "Are you sure you want to enable this post?"
            : action === "disable"
              ? "Are you sure you want to disable this post?"
              : action === "expire"
                ? "Are you sure you want to expire this post?"
                : "Are you sure you want to delete this post?",
        onConfirm: async () => {
          if (action === "enable" || action === "disable")
            await updateDoc(ref, { status: action === "enable" ? "active" : "disabled" });
          else if (action === "expire") await updateDoc(ref, { status: "expired" });
          else if (action === "delete") await deleteDoc(ref);
          updatePosts((prev) => ({
            ...prev,
            [col]: action === "delete"
              ? prev[col].filter((p) => p.id !== post.id)
              : prev[col].map((p) =>
                p.id === post.id
                  ? {
                    ...p, status:
                      action === "expire" ? "expired"
                        : action === "enable" ? "active"
                          : action === "disable" ? "disabled"
                            : p.status
                  }
                  : p),
          }));
          closeMenu();
          setShowConfirm(false);
        },
      });
    } else if (action === "about") {
      setShowAbout(true);
      closeMenu();
    }
  }

  const status = post.status || "active";

  return (
    <div className="absolute right-8 top-8 z-10 bg-white rounded-xl shadow-xl border border-gray-100 min-w-[140px] overflow-hidden animate-fade-in" ref={menuRef}>
      <div className="flex flex-col py-1">
        {status === "active" && (
          <>
            <button className="px-4 py-2 text-left text-sm hover:bg-gray-50 text-gray-700" onClick={() => handleAction("edit")}>Edit</button>
            <button className="px-4 py-2 text-left text-sm hover:bg-gray-50 text-gray-700" onClick={() => handleAction("disable")}>Disable</button>
            <button className="px-4 py-2 text-left text-sm hover:bg-gray-50 text-gray-700" onClick={() => handleAction("expire")}>Expire</button>
          </>
        )}
        {status === "disabled" && (
          <>
            <button className="px-4 py-2 text-left text-sm hover:bg-gray-50 text-gray-700" onClick={() => handleAction("enable")}>Enable</button>
            <button className="px-4 py-2 text-left text-sm hover:bg-gray-50 text-gray-700" onClick={() => handleAction("expire")}>Expire</button>
          </>
        )}
        <button className="px-4 py-2 text-left text-sm hover:bg-red-50 text-red-600" onClick={() => handleAction("delete")}>Delete</button>
        <div className="h-px bg-gray-100 my-1"></div>
        <button className="px-4 py-2 text-left text-sm hover:bg-gray-50 text-gray-500" onClick={() => handleAction("about")}>About</button>
      </div>
    </div>
  );
}
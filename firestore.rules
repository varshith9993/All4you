rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isDocOwner(resource) {
      return isAuthenticated() && (request.auth.uid == resource.data.createdBy || request.auth.uid == resource.data.userId);
    }
    
    // Profiles collection
    match /profiles/{userId} {
      // Anyone can read profiles (for viewing user info)
      allow read: if true;
      
      // Only the user can create/update their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating']));
      
      // Only the user can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // Workers collection
    match /workers/{workerId} {
      // Anyone can read workers (public posts)
      allow read: if true;
      
      // Authenticated users can create workers
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      
      // Only the creator can update their worker post, or anyone can update ONLY the rating
      allow update: if isDocOwner(resource) || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating']));
      
      // Only the creator can delete their worker post
      allow delete: if isDocOwner(resource);
    }
    
    // Services collection
    match /services/{serviceId} {
      // Anyone can read services (public posts)
      allow read: if true;
      
      // Authenticated users can create services
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      
      // Only the creator can update their service post, or anyone can update ONLY the rating
      allow update: if isDocOwner(resource) || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating']));
      
      // Only the creator can delete their service post
      allow delete: if isDocOwner(resource);
    }
    
    // Ads collection
    match /ads/{adId} {
      // Anyone can read ads (public posts)
      allow read: if true;
      
      // Authenticated users can create ads
      allow create: if isAuthenticated() && request.resource.data.createdBy == request.auth.uid;
      
      // Only the creator can update their ad post, or anyone can update ONLY the rating
      allow update: if isDocOwner(resource) || (isAuthenticated() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating']));
      
      // Only the creator can delete their ad post
      allow delete: if isDocOwner(resource);
    }
    
    // Worker Reviews
    match /workerReviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Only the review creator can update their review
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Review creator OR the post owner can delete reviews
      allow delete: if isDocOwner(resource) || 
                       ('workerId' in resource.data && get(/databases/$(database)/documents/workers/$(resource.data.workerId)).data.createdBy == request.auth.uid);
    }
    
    // Service Reviews
    match /serviceReviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Only the review creator can update their review
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Review creator OR the post owner can delete reviews
      allow delete: if isDocOwner(resource) || 
                       ('serviceId' in resource.data && get(/databases/$(database)/documents/services/$(resource.data.serviceId)).data.createdBy == request.auth.uid);
    }
    
    // Ad Reviews
    match /adReviews/{reviewId} {
      // Anyone can read reviews
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Only the review creator can update their review
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Review creator OR the post owner can delete reviews
      allow delete: if isDocOwner(resource) || 
                       ('adId' in resource.data && get(/databases/$(database)/documents/ads/$(resource.data.adId)).data.createdBy == request.auth.uid);
    }
    
    // Worker Favorites
    match /workerFavorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isAuthenticated();
      
      // Users can create favorites (favoriteId format: userId_workerId)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own favorites
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Service Favorites
    match /serviceFavorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isAuthenticated();
      
      // Users can create favorites (favoriteId format: userId_serviceId)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own favorites
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Ad Favorites
    match /adFavorites/{favoriteId} {
      // Users can read their own favorites
      allow read: if isAuthenticated();
      
      // Users can create favorites (favoriteId format: userId_adId)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can delete their own favorites
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Notifications
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Anyone can create notifications (for system/app notifications)
      allow create: if isAuthenticated();
      
      // Users can update their own notifications (e.g., mark as read)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can delete their own notifications
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Chats
    match /chats/{chatId} {
      // Users can read chats they're part of
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Authenticated users can create chats
      allow create: if isAuthenticated() && request.auth.uid in request.resource.data.participants;
      
      // Participants can update chat (e.g., mute, block)
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Participants can delete chat
      allow delete: if isAuthenticated() && request.auth.uid in resource.data.participants;
      
      // Chat messages subcollection
      match /messages/{messageId} {
        // Participants can read messages
        allow read: if isAuthenticated() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Participants can create messages
        allow create: if isAuthenticated() && 
                        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
                        request.resource.data.senderId == request.auth.uid;
        
        // Sender can update their own messages (e.g., edit, mark as deleted)
        allow update: if isAuthenticated() && 
                        (resource.data.senderId == request.auth.uid || 
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
        
        // Sender can delete their own messages
        allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      }
    }
    
    // Notes
    match /notes/{noteId} {
      // Users can only read their own notes
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can create their own notes
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own notes
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Users can delete their own notes
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Feedback
    match /feedback/{feedbackId} {
      // Only admins can read feedback (you can add admin check here)
      allow read: if false; // Change to admin check if needed
      
      // Authenticated users can submit feedback
      allow create: if isAuthenticated();
      
      // No updates or deletes allowed
      allow update, delete: if false;
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}